import os
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from base64 import urlsafe_b64encode, urlsafe_b64decode
def get_file_key(file_path):
    with open(file_path, 'rb') as f:
        file_content = f.read()
    digest = hashes.Hash(hashes.SHA256(), backend=default_backend())
    digest.update(file_content)
    return digest.finalize()
def derive_key(password, salt=None):
    if salt is None:
        salt = os.urandom(16)
    kdf = PBKDF2HMAC(
        algorithm=hashes.SHA256(),
        length=32,
        salt=salt,
        iterations=100000,
        backend=default_backend()
    )
    key = kdf.derive(password)
    return key, salt
def encrypt(message, password):
    key, salt = derive_key(password)
    algorithm = algorithms.AES(key)
    iv = os.urandom(12)
    cipher = Cipher(algorithm, modes.GCM(iv), backend=default_backend())
    encryptor = cipher.encryptor()
    ct = encryptor.update(message.encode()) + encryptor.finalize()
    return f"{urlsafe_b64encode(iv).decode('utf-8')}${urlsafe_b64encode(salt).decode('utf-8')}${urlsafe_b64encode(ct).decode('utf-8')}${urlsafe_b64encode(encryptor.tag).decode('utf-8')}"
def decrypt(combined, password):
    iv, salt, ct, tag = combined.split('$')
    iv = urlsafe_b64decode(iv)
    salt = urlsafe_b64decode(salt)
    ct = urlsafe_b64decode(ct)
    tag = urlsafe_b64decode(tag)
    key, _ = derive_key(password, salt)
    algorithm = algorithms.AES(key)
    cipher = Cipher(algorithm, modes.GCM(iv, tag), backend=default_backend())
    decryptor = cipher.decryptor()
    return decryptor.update(ct).decode('utf-8')
def main():
    file_path = input("Введите путь к файлу-ключу: ")

    if not os.path.exists(file_path):
        print("Файл не найден!")
        return

    file_key = get_file_key(file_path)

    action = input("Выберите действие (1 - шифрование, 2 - дешифрование): ")

    if action == "1":
        message = input("Введите сообщение для шифрования: ")
        encrypted_message = encrypt(message, file_key)
        print("Encrypted:", encrypted_message)
    elif action == "2":
        encrypted_message = input("Введите зашифрованное сообщение: ")
        decrypted_message = decrypt(encrypted_message, file_key)
        print("Decrypted:", decrypted_message)
    else:
        print("Неверный выбор!")


if __name__ == "__main__":
    main()
